code cleanups
fix bugs in optimizer
